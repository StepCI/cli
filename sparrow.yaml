tasks:
  -
    name: tests
    default: true
    language: Python
    init: |
      import glob
      for file in glob.glob("source/examples/*.yaml"):
        run_task("stepci_run",{ "workflow" : file })
    code: |
      if "failure" in get_state():
        raise Exception("some tests errored")
      else:
        print("all tests passed")
    subtasks:
      -
        name: stepci_run
        language: Bash
        code: |
          stepci run $workflow
          code=$?
          if [ "$code" -ne "0" ]; then
            cat << 'HERE' > $cache_root_dir/state.json
              {
                "failure" : true 
              }
            HERE
          fi
    depends:
      -
        name: install 
  -
    name: install
    language: Bash
    code: |
      sudo npm install -g stepci
    depends:
      -
        name: install-deps
  -
    name: install-deps
    language: Bash
    code: |
      sudo apk add --update nodejs npm python3 
